# 鲁米-面试题（Mq）

## 01｜消息队列

### 你用过消息队列吗？主要用来解决什么问题？异步、削峰和解耦你能各举一个例子吗？

### 你用的是哪个消息队列？为什么使用它而不用别的消息队列

### 为什么你一定要用消息队列？不用行不行？不用有什么缺点？

### 在对接多个下游的时候，直接用 RPC 调用行不行？为什么？

### 为什么说使用消息队列可以提高性能？

### 为什么说使用消息队列可以提高扩展性？

### 为什么说使用消息队列可以提高可用性？

### 为什么秒杀场景中经常用消息队列？怎么用的？

### 订单超时取消可以怎么实现？

### 你了解事件驱动吗？

### 什么是 SAGA 事务？怎么利用事件驱动来设计一个 SAGA 事务框架？

## 02｜延迟消息

### 什么是延迟消息？你有没有用过？可以用来解决什么问题？

### Kafka 支不支持延迟消息？为什么 Kafka 不支持？

### RabbitMQ 支不支持延迟消息？怎么支持的？

### RabbitMQ 的延迟消息解决方案有什么缺点？让你来改进，你会怎么办？

### 什么是死信队列？什么是消息 ttl？

### 如果要让 Kafka 支持延迟消息你会怎么做？你有几种方案？各有什么优缺点？

### 在你的延迟消息队列方案里面，时间有多精确？比如说我希望在 10:00:00 发出来，你能保证这个一定恰好在这个时刻发出来吗？误差有多大？你能进一步提高时间精确性吗？

### 在分区设置不同延迟时间的方案里，能不能支持随机延迟时间？

### 在分区设置不同延迟时间的方案里，如果要是发生了 rebalance，会有什么后果？

### 当你从准备转发消息到业务 topic（biz_topic）的时候失败了，有什么后果？怎么办？

### 如果要是不同业务 topic 的并发量有区别，你分库分表怎么解决这种负载不均匀的问题？

### 如果延迟消息还要求有序性，该怎么办？

### 如果你已经将消息转发到了 biz_topic 上，但是更新数据库状态失败了怎么办？

## 03｜消息不丢失

### 什么是 ISR？什么是 OSR？

- 在 Apache Kafka 中，ISR（In-Sync Replicas）和 OSR（Out-of-Sync Replicas）是与分布式复制相关的概念。

### 一个分区什么情况下会被挪进去 ISR，什么时候又会被挪出 ISR？

- IN

	- 初始化分配

	- leader broker 故障

- OUT

	- 副本滞后

	- 副本失效

	- 副本追不上leader

	- 手动干预

### 生产者的 acks 参数有什么含义？你用的是多少？

- acks=0：

	- 生产者发送消息后不会等待任何确认。这意味着生产者将消息发送到 Kafka，然后立即继续发送下一条消息，不关心消息是否成功到达。

	- 这是最低的可靠性保证级别，如果 Kafka Broker 在消息发送后立即宕机，消息可能会丢失。

- acks=1：

	- 生产者会等待 Leader Broker 将消息写入日志后返回一个确认。在这种情况下，只要 Leader Broker 存活，消息就不会丢失。

	- 这是一种中等的可靠性保证级别，适用于许多场景。

- acks=all（或 acks=-1）：

	- 生产者会等待 ISR（In-Sync Replicas）中的所有副本都将消息写入日志后才返回一个确认。这是最高的可靠性保证级别，确保了消息不会丢失，即使 Leader Broker 故障，也可以从 ISR 中选举一个新的 Leader 来保证消息不丢失。

### 怎么感觉业务选择合适的 acks 参数？

### 消息丢失的场景有哪些？

- 网络故障，发送者故障，接受者故障，硬件故障，消息队列故障，错误配置，并发处理问题，负载过高，不可靠的传输协议，过期消息，

### 你遇到过消息丢失的问题吗？是什么原因引起的？你怎么排查的？最终怎么解决的？

### 当生产者收到发送成功的响应之后，消息就肯定不会丢失吗？

### acks 设置为 all，消息就一定不会丢失吗？

### 什么是事务消息？Kafka 支持事务消息吗？

- 对

### 怎么在 Kafka 上支持事务消息？

### 什么是本地消息表？拿来做什么的？

### 你是怎么保证你在执行了业务操作之后，消息一定发出去了？

### 怎么保证生产者收到发送成功的响应之后，消息一定不会丢失？需要调整哪些参数？

### 什么是 unclean 选举？有什么问题？你用的 Kafka 允许 unclean 选举吗？

### 在你设计的回查方案里面，你怎么知道应该回查哪个接口？你这个能同时支持 HTTP 和 RPC 吗？能方便扩展到别的协议吗？

### 你的回查机制有没有可能先收到提交消息？再收到准备消息？怎么保证两者的顺序？

### 果你已经把消息发到了业务 topic 上，但是你标记已发送失败了，怎么办？

## 04｜重复消费

### 什么是布隆过滤器？

- 布隆过滤器（Bloom Filter）是一种用于检查一个元素是否属于一个集合的数据结构，它以很低的空间开销和快速的查询速度为特点。布隆过滤器是一个由比特位组成的向量，用于表示一个元素是否在集合中。

- 初始化：布隆过滤器由一个长度为 m 的比特位向量（初始化时所有比特位都设置为 0）和 k 个独立的哈希函数组成。

- 添加元素：当一个元素被添加到布隆过滤器中时，通过 k 个哈希函数将元素映射到 m 个不同的比特位，然后将这些比特位设置为 1。

- 查询元素：当查询一个元素是否属于集合时，同样地，通过 k 个哈希函数将元素映射到 m 个比特位，检查这些比特位是否都为 1。如果有任何一个比特位为 0，可以确定元素不在集合中。但如果所有的比特位都为 1，那么元素可能在集合中，也可能不在。

### 什么是 bit array？

- Bit array（位数组），也称为bit set或bit vector，是一种基本的数据结构，用于以紧凑的方式存储和操作位或布尔值。它将每个元素表示为一个固定数量的比特位，通常以数组的形式存储。

### 为什么说尽量把消费者设计成幂等的？

### 什么场景会造成重复消费？

### 什么是恰好一次语义，Kafka 支持恰好一次语义吗？

- 恰好一次语义（Exactly-Once Semantics）是指在消息传递系统中，每条消息最多被处理一次，不会发生重复处理或丢失。这是一种非常高的可靠性保证级别，特别适用于对消息处理的准确性要求非常高的场景。

### 利用唯一索引来解决幂等问题，有什么缺陷？

### 高并发场景下，怎么解决幂等问题？

- 使用唯一标识符：

- 使用token方重复

- 记录处理状态

- 使用版本号

- 使用消息队列

- 使用分布式锁

- 设计幂等性接口

### 在你的高并发幂等方案里面，为什么要引入 Redis？

- 分布式锁

- 原子操作

- 数据结构

- 缓存

- 超时机制

- 分布式环境支持

### Redis 里面的 Key 过期时间该怎么确定？

### 布隆过滤器 + Redis + 唯一索引里面，去掉布隆过滤器行不行？去掉 Redis 呢？去掉唯一索引呢？

### 布隆过滤器 + Redis + 唯一索引方案中能不能使用本地布隆过滤器？怎么用？

### 布隆过滤器 + Redis + 唯一索引有什么缺陷？

## 05｜架构设计

### Kafka 为什么要引入分区？只有 topic 行不行？

- Kafka 引入分区的主要目的是为了提高消息的并发处理能力、提升扩展性，并支持水平扩展。

- 并发处理，水平扩展，容错，负载均衡，顺序消费，分区件，

### Kafka 为什么要强调把 topic 的分区分散在不同的 broker 上？

### Kafka 为什么要引入消费者组概念？只有消费者行不行？

### Kafka 为什么要引入 topic？

- Kafka 引入主题（Topic）的概念是为了方便将消息进行逻辑上的分类和组织，以及支持多个消费者对不同类别的消息进行订阅和处理。

### 为什么 Kafka 性能那么好？

- 顺序写入，顺序读取

- 零拷贝技术

- 批量处理

- 消息压缩

- 分布式架构

- 持久化

- 分区和消费组

- 简单的消息寻址方式

- 异步处理

### 为什么零拷贝性能那么好？

### 写磁盘一定很慢吗？顺序写为什么很快？

### 批量操作为什么快？节省了什么资源？

### 分区过多有什么问题？topic 过多有什么问题？

### 分区有什么好处？

### 你有优化过 Kafka 的 JVM 吗？怎么优化的？

- 适当配置堆内存大小：

- GC调优

- 避免频繁fullgc

- 合理设置线程数量

- 使用压缩

- 关闭不必要的服务

- 监控

- 升级jvm版本

